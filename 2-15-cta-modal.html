<style>
  /* 플로팅 버튼 */
  {{#if property.showFloatingButton}}
  .cta-floating-button {
    position: fixed;
    bottom: {{property.floatingButtonBottomOffset}}px;
    right: {{property.floatingButtonRightOffset}}px;
    width: {{property.floatingButtonSize}}px;
    height: {{property.floatingButtonSize}}px;
    background-color: {{property.floatingButtonBg}};
    color: {{property.floatingButtonColor}};
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    cursor: pointer;
    box-shadow: 0 4px 20px {{property.floatingButtonBg}}66;
    z-index: 999;
    transition: all 0.3s ease;
    border: none;
  }

  .cta-floating-button:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 30px {{property.floatingButtonBg}}88;
  }

  {{#if property.floatingButtonPulse}}
  @keyframes pulse {
    0%, 100% {
      box-shadow: 0 4px 20px {{property.floatingButtonBg}}66;
    }
    50% {
      box-shadow: 0 4px 20px {{property.floatingButtonBg}}66, 0 0 0 10px {{property.floatingButtonBg}}22;
    }
  }

  .cta-floating-button {
    animation: pulse 2s infinite;
  }

  .cta-floating-button:hover {
    animation: none;
  }
  {{/if}}

  .floating-button-text {
    display: none;
  }

  @media (min-width: 769px) {
    .cta-floating-button {
      width: auto;
      border-radius: 100px;
      padding: 0 24px;
      gap: 8px;
    }

    .floating-button-text {
      display: block;
      font-family: var(--font-family-body);
      font-size: 15px;
      font-weight: 600;
      line-height: 1.5;
      white-space: nowrap;
    }
  }
  {{/if}}

  /* 모달 오버레이 */
  .cta-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: {{property.overlayBg}};
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 1000;
    padding: 20px;
    overflow-y: auto;
  }

  .cta-modal-overlay.active {
    display: flex;
  }

  /* 모달 컨테이너 */
  .cta-modal {
    background-color: {{property.modalBg}};
    max-width: {{property.modalMaxWidth}}px;
    width: 100%;
    border-radius: {{property.modalRadius}}px;
    padding: {{property.modalPaddingY}}px {{property.modalPaddingX}}px;
    position: relative;
    {{#if property.modalShadowEnabled}}
    box-shadow: {{property.modalShadowX}}px {{property.modalShadowY}}px {{property.modalShadowBlur}}px {{property.modalShadowColor}};
    {{/if}}
    max-height: 90vh;
    overflow-y: auto;
  }

  /* 모달 애니메이션 */
  {{#if (eq property.modalAnimation "fade-in")}}
  .cta-modal-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .cta-modal-overlay.active {
    opacity: 1;
  }
  {{/if}}

  {{#if (eq property.modalAnimation "scale-in")}}
  .cta-modal-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .cta-modal-overlay.active {
    opacity: 1;
  }
  .cta-modal {
    transform: scale(0.8);
    transition: transform 0.3s ease;
  }
  .cta-modal-overlay.active .cta-modal {
    transform: scale(1);
  }
  {{/if}}

  {{#if (eq property.modalAnimation "slide-up")}}
  .cta-modal-overlay {
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .cta-modal-overlay.active {
    opacity: 1;
  }
  .cta-modal {
    transform: translateY(50px);
    transition: transform 0.3s ease;
  }
  .cta-modal-overlay.active .cta-modal {
    transform: translateY(0);
  }
  {{/if}}

  /* 모달 헤더 */
  .cta-modal-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    margin-bottom: {{property.modalHeadingMarginBottom}}px;
  }

  .cta-modal-heading {
    font-family: var(--font-family-heading);
    font-size: {{property.modalHeadingFontSizeDesktop}}px;
    font-weight: {{property.modalHeadingFontWeight}};
    line-height: {{property.modalHeadingLineHeight}};
    color: {{property.modalHeadingColor}};
    margin: 0;
    flex: 1;
  }

  .cta-modal-close {
    background: none;
    border: none;
    font-size: 28px;
    color: #999999;
    cursor: pointer;
    padding: 0;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s ease;
    flex-shrink: 0;
    margin-left: 16px;
  }

  .cta-modal-close:hover {
    background-color: #F0F0F0;
    color: #333333;
  }

  /* 모달 설명 */
  .cta-modal-description {
    font-family: var(--font-family-body);
    font-size: {{property.modalDescriptionFontSizeDesktop}}px;
    font-weight: {{property.modalDescriptionFontWeight}};
    line-height: {{property.modalDescriptionLineHeight}};
    color: {{property.modalDescriptionColor}};
    margin-bottom: {{property.modalDescriptionMarginBottom}}px;
    white-space: pre-line;
  }

  /* 폼 필드 */
  .cta-form-field {
    margin-bottom: {{property.fieldSpacing}}px;
  }

  .cta-form-label {
    display: block;
    font-family: var(--font-family-body);
    font-size: {{property.labelFontSizeDesktop}}px;
    font-weight: {{property.labelFontWeight}};
    line-height: {{property.labelLineHeight}};
    color: {{property.labelColor}};
    margin-bottom: {{property.labelMarginBottom}}px;
  }

  .cta-form-label .required {
    color: #FF4444;
    margin-left: 2px;
  }

  .cta-form-input,
  .cta-form-select,
  .cta-form-textarea {
    width: 100%;
    font-family: var(--font-family-body);
    font-size: {{property.inputFontSizeDesktop}}px;
    font-weight: {{property.inputFontWeight}};
    line-height: {{property.inputLineHeight}};
    color: {{property.inputColor}};
    background-color: {{property.inputBg}};
    border: {{property.inputBorderWidth}}px solid {{property.inputBorder}};
    border-radius: {{property.inputRadius}}px;
    padding: {{property.inputPaddingY}}px {{property.inputPaddingX}}px;
    transition: all 0.2s ease;
    box-sizing: border-box;
  }

  .cta-form-input:focus,
  .cta-form-select:focus,
  .cta-form-textarea:focus {
    outline: none;
    border-color: {{property.primaryButtonBg}};
    background-color: #FFFFFF;
  }

  .cta-form-textarea {
    min-height: 100px;
    resize: vertical;
  }

  .cta-form-select {
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg width='12' height='8' viewBox='0 0 12 8' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L6 6L11 1' stroke='%23333' stroke-width='2' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right {{property.inputPaddingX}}px center;
    padding-right: calc({{property.inputPaddingX}}px + 24px);
  }

  /* 라디오 버튼 */
  .cta-radio-group {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .cta-radio-option {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .cta-radio-option input[type="radio"] {
    width: 18px;
    height: 18px;
    cursor: pointer;
  }

  .cta-radio-option label {
    font-family: var(--font-family-body);
    font-size: {{property.inputFontSizeDesktop}}px;
    font-weight: {{property.inputFontWeight}};
    line-height: {{property.inputLineHeight}};
    color: {{property.inputColor}};
    cursor: pointer;
    margin: 0;
  }

  /* 버튼 영역 */
  .cta-modal-buttons {
    display: flex;
    gap: {{property.buttonGap}}px;
    margin-top: {{property.buttonMarginTop}}px;
    flex-wrap: wrap;
  }

  .cta-modal-button {
    flex: 1;
    min-width: 140px;
    font-family: var(--font-family-body);
    font-size: {{property.buttonFontSizeDesktop}}px;
    font-weight: {{property.buttonFontWeight}};
    line-height: {{property.buttonLineHeight}};
    border-radius: {{property.buttonRadius}}px;
    padding: {{property.buttonPaddingY}}px {{property.buttonPaddingX}}px;
    border: none;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
  }

  {{#if property.showPrimaryButton}}
  .cta-modal-button-primary {
    background-color: {{property.primaryButtonBg}};
    color: {{property.primaryButtonColor}};
  }

  .cta-modal-button-primary:hover {
    background-color: {{property.primaryButtonBgHover}};
  }
  {{/if}}

  {{#if property.showSecondaryButton}}
  .cta-modal-button-secondary {
    background-color: {{property.secondaryButtonBg}};
    color: {{property.secondaryButtonColor}};
  }

  .cta-modal-button-secondary:hover {
    background-color: {{property.secondaryButtonBgHover}};
  }
  {{/if}}

  /* 하단 텍스트 */
  .cta-modal-footer-text {
    font-family: var(--font-family-body);
    font-size: {{property.footerTextFontSizeDesktop}}px;
    font-weight: {{property.footerTextFontWeight}};
    line-height: {{property.footerTextLineHeight}};
    color: {{property.footerTextColor}};
    margin-top: {{property.footerTextMarginTop}}px;
    text-align: center;
    white-space: pre-line;
  }

  /* 모바일 */
  @media (max-width: 768px) {
    .cta-modal {
      padding: {{property.mobileModalPaddingY}}px {{property.mobileModalPaddingX}}px;
      border-radius: {{property.modalRadius}}px {{property.modalRadius}}px 0 0;
      margin-top: auto;
    }

    .cta-modal-heading {
      font-size: {{property.modalHeadingFontSizeMobile}}px;
    }

    .cta-modal-description {
      font-size: {{property.modalDescriptionFontSizeMobile}}px;
    }

    .cta-form-label {
      font-size: {{property.labelFontSizeMobile}}px;
    }

    .cta-form-input,
    .cta-form-select,
    .cta-form-textarea,
    .cta-radio-option label {
      font-size: {{property.inputFontSizeMobile}}px;
    }

    .cta-modal-button {
      font-size: {{property.buttonFontSizeMobile}}px;
      min-width: 120px;
    }

    .cta-modal-footer-text {
      font-size: {{property.footerTextFontSizeMobile}}px;
    }

    .cta-modal-overlay {
      align-items: flex-end;
      padding: 0;
    }
  }
</style>

<template>
  <!-- 플로팅 버튼 -->
  {{#if property.showFloatingButton}}
  <button class="cta-floating-button" data-action="open-modal">
    <span class="floating-button-icon">{{property.floatingButtonIcon}}</span>
    <span class="floating-button-text">{{property.floatingButtonText}}</span>
  </button>
  {{/if}}

  <!-- 모달 오버레이 -->
  <div class="cta-modal-overlay" data-modal-overlay>
    <div class="cta-modal">
      <!-- 모달 헤더 -->
      <div class="cta-modal-header">
        <h2 class="cta-modal-heading">{{property.modalHeading}}</h2>
        <button class="cta-modal-close" data-action="close-modal" aria-label="닫기">×</button>
      </div>

      <!-- 모달 설명 -->
      {{#if property.modalDescription}}
      <p class="cta-modal-description">{{property.modalDescription}}</p>
      {{/if}}

      <!-- 폼 -->
      <form class="cta-modal-form" data-cta-form>
        <!-- 회사명 -->
        {{#if property.showCompanyField}}
        <div class="cta-form-field">
          <label class="cta-form-label">
            회사명<span class="required">*</span>
          </label>
          <input type="text" class="cta-form-input" name="company" placeholder="회사명을 입력하세요" required>
        </div>
        {{/if}}

        <!-- 담당자 이름 -->
        {{#if property.showNameField}}
        <div class="cta-form-field">
          <label class="cta-form-label">
            담당자 이름<span class="required">*</span>
          </label>
          <input type="text" class="cta-form-input" name="name" placeholder="이름을 입력하세요" required>
        </div>
        {{/if}}

        <!-- 연락처 -->
        {{#if property.showPhoneField}}
        <div class="cta-form-field">
          <label class="cta-form-label">
            연락처<span class="required">*</span>
          </label>
          <input type="tel" class="cta-form-input" name="phone" placeholder="010-0000-0000" required>
        </div>
        {{/if}}

        <!-- 이메일 -->
        {{#if property.showEmailField}}
        <div class="cta-form-field">
          <label class="cta-form-label">
            이메일<span class="required">*</span>
          </label>
          <input type="email" class="cta-form-input" name="email" placeholder="example@company.com" required>
        </div>
        {{/if}}

        <!-- 관심 솔루션 -->
        {{#if property.showSolutionField}}
        <div class="cta-form-field">
          <label class="cta-form-label">
            관심 솔루션<span class="required">*</span>
          </label>
          <select class="cta-form-select" name="solution" required>
            <option value="">선택하세요</option>
            {{#each (split property.solutionOptions "|")}}
            <option value="{{this}}">{{this}}</option>
            {{/each}}
          </select>
        </div>
        {{/if}}

        <!-- 기업 규모 -->
        {{#if property.showCompanySizeField}}
        <div class="cta-form-field">
          <label class="cta-form-label">기업 규모 (선택)</label>
          <div class="cta-radio-group">
            {{#each (split property.companySizeOptions "|")}}
            <div class="cta-radio-option">
              <input type="radio" name="company-size" value="{{this}}" id="size-{{@index}}">
              <label for="size-{{@index}}">{{this}}</label>
            </div>
            {{/each}}
          </div>
        </div>
        {{/if}}

        <!-- 추가 요청사항 -->
        {{#if property.showMessageField}}
        <div class="cta-form-field">
          <label class="cta-form-label">추가 요청사항 (선택)</label>
          <textarea class="cta-form-textarea" name="message" placeholder="문의하실 내용을 입력하세요" maxlength="{{property.messageFieldMaxLength}}"></textarea>
        </div>
        {{/if}}

        <!-- 버튼 영역 -->
        <div class="cta-modal-buttons">
          {{#if property.showSecondaryButton}}
          <button type="button" class="cta-modal-button cta-modal-button-secondary" data-action="secondary">
            {{property.secondaryButtonText}}
          </button>
          {{/if}}

          {{#if property.showPrimaryButton}}
          <button type="submit" class="cta-modal-button cta-modal-button-primary">
            {{property.primaryButtonText}}
          </button>
          {{/if}}
        </div>

        <!-- 하단 텍스트 -->
        {{#if property.footerText}}
        <p class="cta-modal-footer-text">{{property.footerText}}</p>
        {{/if}}
      </form>
    </div>
  </div>
</template>

<script>
  const container = bm.container;
  const context = bm.context;

  // Helper: 문자열 분리 (파이프로 구분된 옵션)
  if (!Handlebars.helpers.split) {
    Handlebars.registerHelper('split', function(str, delimiter) {
      if (!str) return [];
      return str.split(delimiter);
    });
  }

  function init() {
    const modal = container.querySelector('.cta-modal-overlay');
    const floatingButton = container.querySelector('.cta-floating-button');
    const form = container.querySelector('[data-cta-form]');

    if (!modal) return;

    // 모달 열기/닫기 이벤트 (이벤트 위임)
    container.addEventListener('click', (e) => {
      const target = e.target.closest('[data-action]');
      if (!target) return;

      const action = target.dataset.action;

      if (action === 'open-modal') {
        e.preventDefault();
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
      } else if (action === 'close-modal') {
        e.preventDefault();
        modal.classList.remove('active');
        document.body.style.overflow = '';
      } else if (action === 'secondary') {
        e.preventDefault();
        // Secondary 버튼 동작 (자료 다운로드 등)
        alert('자료 다운로드 기능은 식스샵 프로에서 직접 구현해주세요.');
      }
    });

    // 오버레이 클릭 시 닫기
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    });

    // ESC 키로 닫기
    const handleEscKey = (e) => {
      if (e.key === 'Escape' && modal.classList.contains('active')) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
      }
    };

    document.addEventListener('keydown', handleEscKey);

    // 폼 제출 이벤트
    if (form) {
      form.addEventListener('submit', (e) => {
        e.preventDefault();

        // 폼 데이터 수집
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);

        // 실제 제출 로직은 식스샵 프로에서 구현
        alert('폼 제출 기능은 식스샵 프로에서 직접 구현해주세요.\n\n제출될 데이터:\n' + JSON.stringify(data, null, 2));

        // 폼 초기화 및 모달 닫기
        form.reset();
        modal.classList.remove('active');
        document.body.style.overflow = '';
      });
    }

    // Cleanup
    if (bm.onDestroy) {
      const oldDestroy = bm.onDestroy;
      bm.onDestroy = () => {
        document.removeEventListener('keydown', handleEscKey);
        document.body.style.overflow = '';
        oldDestroy();
      };
    } else {
      bm.onDestroy = () => {
        document.removeEventListener('keydown', handleEscKey);
        document.body.style.overflow = '';
      };
    }
  }

  init();

  bm.onContextChange = () => {
    init();
  };
</script>
